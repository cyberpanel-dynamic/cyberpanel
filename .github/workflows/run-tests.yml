name: Test whether Cyberpanel works
on: push

jobs:
  centos7:
    name: Cyberpanel on Centos 7
    runs-on: ubuntu-latest
    container:
      image: centos:centos7
      env:
        USER: cyberpanel-dynamic
        REPO: cyberpanel
        BRANCH: stable
        UPGRADE_BRANCH: v2.3.2
    steps:
      - name: Install Cyberpanel from current Repository
        run: printf "\n1\n1\n\n\n\n\n\n" | bash <(curl https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh)
        shell: bash
      - name: Restart after installation
        run: reboot
        shell: bash
      - name: Check if installation was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
      - name: Upgrade Cyberpanel from current Repository
        run: printf "\n\n\n\n\n\n\n\n" | sh <(curl https://raw.githubusercontent.com/$USER/$REPO/$UPGRADE_BRANCH/preUpgrade.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/preUpgrade.sh)
        shell: bash
      - name: Restart after Upgrade
        run: reboot
        shell: bash
      - name: check if upgrade was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
  centos8:
    name: Cyberpanel on Centos 8
    runs-on: ubuntu-latest
    container:
      image: centos:centos8
      env:
        USER: cyberpanel-dynamic
        REPO: cyberpanel
        BRANCH: stable
        UPGRADE_BRANCH: v2.3.2
    steps:
      - name: Fix missing mirrorlist (Bug in CentOS 8 Container)
        run: |
          cd /etc/yum.repos.d/ 
          sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
      - name: Install Cyberpanel from current Repository
        run: printf "\n1\n1\n\n\n\n\n\n" | bash <(curl https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh)
        shell: bash
      - name: Restart after installation
        run: reboot
        shell: bash
      - name: Check if installation was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
      - name: Upgrade Cyberpanel from current Repository
        run: printf "\n\n\n\n\n\n\n\n" | sh <(curl https://raw.githubusercontent.com/$USER/$REPO/$UPGRADE_BRANCH/preUpgrade.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/preUpgrade.sh)
        shell: bash
      - name: Restart after Upgrade
        run: reboot
        shell: bash
      - name: check if upgrade was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
  openeuler2003:
    name: Cyberpanel on Openeuler 20.03
    runs-on: ubuntu-latest
    container:
      image: openeuler/openeuler:20.03
      env:
        USER: cyberpanel-dynamic
        REPO: cyberpanel
        BRANCH: stable
        UPGRADE_BRANCH: v2.3.2
    steps:
      - name: Install wget and curl
        run: |
          yum update -y
          yum install wget curl
      - name: Install Cyberpanel from current Repository
        run: printf "\n1\n1\n\n\n\n\n\n" | bash <(curl https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh)
        shell: bash
      - name: Restart after installation
        run: reboot
        shell: bash
      - name: Check if installation was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
      - name: Upgrade Cyberpanel from current Repository
        run: printf "\n\n\n\n\n\n\n\n" | sh <(curl https://raw.githubusercontent.com/$USER/$REPO/$UPGRADE_BRANCH/preUpgrade.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/preUpgrade.sh)
        shell: bash
      - name: Restart after Upgrade
        run: reboot
        shell: bash
      - name: check if upgrade was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
  openeuler2203:
    name: Cyberpanel on Openeuler 22.03
    runs-on: ubuntu-latest
    container:
      image: openeuler/openeuler:22.03
      env:
        USER: cyberpanel-dynamic
        REPO: cyberpanel
        BRANCH: stable
        UPGRADE_BRANCH: v2.3.2
    steps:
      - name: Install wget and curl
        run: |
          yum update -y
          yum install wget curl
      - name: Install Cyberpanel from current Repository
        run: printf "\n1\n1\n\n\n\n\n\n" | bash <(curl https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh)
        shell: bash
      - name: Restart after installation
        run: reboot
        shell: bash
      - name: Check if installation was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
      - name: Upgrade Cyberpanel from current Repository
        run: printf "\n\n\n\n\n\n\n\n" | sh <(curl https://raw.githubusercontent.com/$USER/$REPO/$UPGRADE_BRANCH/preUpgrade.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/preUpgrade.sh)
        shell: bash
      - name: Restart after Upgrade
        run: reboot
        shell: bash
      - name: check if upgrade was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
  ubuntu1804:
    name: Cyberpanel on Ubuntu 18.04
    runs-on: ubuntu-latest
    container:
      image: ubuntu:bionic
      env:
        USER: cyberpanel-dynamic
        REPO: cyberpanel
        BRANCH: stable
        UPGRADE_BRANCH: v2.3.2
    steps:
      - name: Install wget and curl
        run: apt update -y && apt install -y wget curl
      - name: Install Cyberpanel from current Repository
        run: printf "\n1\n1\n\n\n\n\n\n" | bash <(curl https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh)
        shell: bash
      - name: Restart after installation
        run: reboot
        shell: bash
      - name: Check if installation was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
      - name: Upgrade Cyberpanel from current Repository
        run: printf "\n\n\n\n\n\n\n\n" | sh <(curl https://raw.githubusercontent.com/$USER/$REPO/$UPGRADE_BRANCH/preUpgrade.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/preUpgrade.sh)
        shell: bash
      - name: Restart after Upgrade
        run: reboot
        shell: bash
      - name: check if upgrade was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
  ubuntu2004:
    name: Cyberpanel on Ubuntu 20.04
    runs-on: ubuntu-latest
    container:
      image: ubuntu:focal
      env:
        USER: cyberpanel-dynamic
        REPO: cyberpanel
        BRANCH: stable
        UPGRADE_BRANCH: v2.3.2
    steps:
      - name: Install wget and curl
        run: apt update -y && apt install -y wget curl
      - name: Install Cyberpanel from current Repository
        run: printf "\n1\n1\n\n\n\n\n\n" | bash <(curl https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/install.sh)
        shell: bash
      - name: Restart after installation
        run: reboot
        shell: bash
      - name: Check if installation was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
      - name: Upgrade Cyberpanel from current Repository
        run: printf "\n\n\n\n\n\n\n\n" | sh <(curl https://raw.githubusercontent.com/$USER/$REPO/$UPGRADE_BRANCH/preUpgrade.sh || wget -O - https://raw.githubusercontent.com/$USER/$REPO/$BRANCH/preUpgrade.sh)
        shell: bash
      - name: Restart after Upgrade
        run: reboot
        shell: bash
      - name: check if upgrade was succesful
        run: curl -s -o /dev/null -w "%{http_code}" 127.0.0.1:8090
        shell: bash
